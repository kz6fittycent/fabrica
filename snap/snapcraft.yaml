name: fabrica
base: core18
version: '0.6'
summary: RepoAdd snaps by simply pointing a web form to a git tree
description: |
  Fabrica is a web service to be run on an lxd appliance. It spawns a
  web ui that allows you to point to cloneable git trees, initializes
  lxd and builds snap packages of the provided source trees.

grade: stable
confinement: strict

apps:
  init:
    command: bin/init.py
    daemon: simple
    plugs:
      - lxd
      - mount-observe
      - network-bind
  build:
    command: bin/build.py
    plugs:
      - lxd
      - mount-observe
      - network
      - network-bind
      - system-observe
  web:
    command: bin/web
    daemon: simple
    plugs:
      - lxd
      - mount-observe
      - network
      - network-bind
      - system-observe
    environment:
      GIT_TEMPLATE_DIR: $SNAP/share/git-core/templates
      GIT_CONFIG_NOSYSTEM: "true"
      GIT_EXEC_PATH: $SNAP/libexec/git-core
      GIT_TEXTDOMAINDIR: $SNAP/usr/share/locale
  watch:
    command: bin/watch
    daemon: simple
    plugs:
      - lxd
      - mount-observe
      - network
      - network-bind
      - system-observe
    environment:
      GIT_TEMPLATE_DIR: $SNAP/share/git-core/templates
      GIT_CONFIG_NOSYSTEM: "true"
      GIT_EXEC_PATH: $SNAP/libexec/git-core
      GIT_TEXTDOMAINDIR: $SNAP/usr/share/locale

parts:
  react:
    plugin: nil
    source: .
    override-build: |
      # Install node and npm
      curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.3/install.sh | bash
      export NVM_DIR="$HOME/.nvm"
      . "$NVM_DIR/nvm.sh"
      . "$NVM_DIR/bash_completion"

      nvm install lts/*
      nvm run node --version

      cd webapp
      npm install
      npm run build

      mkdir -p $SNAPCRAFT_PART_INSTALL/static/
      cp -r build/static/css $SNAPCRAFT_PART_INSTALL/static/
      cp -r build/static/js $SNAPCRAFT_PART_INSTALL/static/
      cp -r build/static/images $SNAPCRAFT_PART_INSTALL/static/
      cp build/* $SNAPCRAFT_PART_INSTALL/static/ || :
    build-packages:
      - curl

  pylxd:
    plugin: python
    python-packages:
      - pylxd
    build-packages:
      - libffi-dev
      - libssl-dev
  scripts:
    source: .
    plugin: nil
    override-build: |
      snapcraftctl build
      mkdir -p $SNAPCRAFT_PART_INSTALL/bin
      cp bin/init.py $SNAPCRAFT_PART_INSTALL/bin/
      cp bin/build.py $SNAPCRAFT_PART_INSTALL/bin/
    stage-packages:
      - python3-websockets

  application:
    plugin: go
    source: .
    source-type: git
    build-packages:
      - gcc
    stage-packages:
      - git
      - libcurl4-openssl-dev

  bin:
    source: snap/local
    plugin: dump
    organize:
      "*": /bin/
